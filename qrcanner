import cv2
from pyzbar.pyzbar import decode
from tkinter import Label, Text, END
from tkinterdnd2 import DND_FILES, TkinterDnD
import os

def read_qr(file_path):
    output_box.delete(1.0, END)

    if not os.path.exists(file_path):
        output_box.insert(END, "Dosya yolu geçersiz!\n")
        return

    img = cv2.imread(file_path)

    if img is None:
        output_box.insert(END, "Görsel yüklenemedi!\n")
        return

    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)

    decoded_objects = decode(gray)

    if not decoded_objects:
        output_box.insert(END, "QR kod bulunamadı.\n")
    else:
        for obj in decoded_objects:
            qr_data = obj.data.decode("utf-8")
            output_box.insert(END, f"QR İçeriği:\n{qr_data}\n")

            # QR etrafına dikdörtgen çiz
            points = obj.polygon
            pts = [(p.x, p.y) for p in points]
            for i in range(len(pts)):
                cv2.line(img, pts[i], pts[(i+1) % len(pts)], (0,255,0), 3)

        cv2.imshow("Tespit Edilen QR", img)
        cv2.waitKey(0)
        cv2.destroyAllWindows()

def drop(event):
    file_path = event.data

    # Windows için {} temizleme
    if file_path.startswith("{") and file_path.endswith("}"):
        file_path = file_path[1:-1]

    read_qr(file_path)

# GUI
root = TkinterDnD.Tk()
root.title("QR Kod Okuyucu")
root.geometry("400x300")

label = Label(root, text="QR görselini buraya sürükle",
              bg="lightgray", width=40, height=5)
label.pack(pady=10)

label.drop_target_register(DND_FILES)
label.dnd_bind('<<Drop>>', drop)

output_box = Text(root, height=10)
output_box.pack(padx=10, pady=10)

root.mainloop()
